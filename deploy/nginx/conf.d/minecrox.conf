# Frontend: minecrox.ktoxz.id.vn -> Next.js (container: frontend:3000)
# API: api.ktoxz.id.vn -> FastAPI (container: backend:8000)

# ACME challenge (certbot webroot)
server {
  listen 80;
  listen [::]:80;

  server_name minecrox.ktoxz.id.vn api.ktoxz.id.vn;

  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name minecrox.ktoxz.id.vn;

  ssl_certificate     /etc/letsencrypt/live/minecrox.ktoxz.id.vn/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/minecrox.ktoxz.id.vn/privkey.pem;

  # If you use Cloudflare full/strict, keep this.
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  location / {
    proxy_pass http://frontend:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support (Next.js dev/streaming)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_read_timeout 300;
    proxy_send_timeout 300;
  }
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name api.ktoxz.id.vn;

  ssl_certificate     /etc/letsencrypt/live/api.ktoxz.id.vn/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.ktoxz.id.vn/privkey.pem;

  # Upload size and timeouts for large .zip
  # (multipart has overhead; keep this comfortably above MAX_UPLOAD_BYTES)
  client_max_body_size 120m;
  client_body_timeout 600;

  # If Nginx ever returns an error response (413/502/etc), browsers may show it as a CORS error.
  # These headers make debugging much easier.
  add_header Access-Control-Allow-Origin "https://minecrox.ktoxz.id.vn" always;
  add_header Access-Control-Allow-Credentials "true" always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Requested-With" always;

  if ($request_method = OPTIONS) {
    return 204;
  }

  location / {
    proxy_pass http://backend:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Stream large uploads directly.
    proxy_request_buffering off;

    proxy_read_timeout 600;
    proxy_send_timeout 600;
  }
}
